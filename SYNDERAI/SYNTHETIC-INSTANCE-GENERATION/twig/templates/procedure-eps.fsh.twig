{#
  This is the TWIG file for the creation of an FSH instance including the HTML parts.
  see README.md

  KH since 2025-09-02
#}

%%FSH%% {# tag required #}
Instance: {{ setInstance("Instance-Procedure-" ~ instanceid) }}
InstanceOf: ProcedureUvIps
Title: "Procedure (IPS)"
Description: "Procedure"
Usage: #inline

* id = "{{ instanceid }}"

{# addign headers for HTML table #}
{{ addHEAD_tr() }}
{{ addHEAD_th("Procedure") }}
{{ addHEAD_th("Date") }}
{{ addHEAD_th("Reason") }}
{{ addHEAD_trend() -}}

{{ addHTML_tr() }}

* status = #completed

{# *** HTML td 1: code/display #}
{% if procedure.code %}

* code.coding[0] = {{ procedure.code.system }}#{{ procedure.code.code }} "{{ procedure.code.display }}"

{% if procedure.code.preferredTerm is empty %}
{{ addHTML_td(procedure.code.display) }}
{% else %}
* code.text = "{{ procedure.code.preferredTerm }}"
{{ addHTML_td(procedure.code.preferredTerm) }}
{% endif %}

{% endif %}

{# *** HTML td 2: date #}
{% if procedure.date is empty %}
* onsetDateTime.extension.url = "http://hl7.org/fhir/StructureDefinition/data-absent-reason"
* onsetDateTime.extension.valueCode = #unknown
{{ addHTML_td("?") }}
{% else %}
* performedDateTime = "{{ procedure.date }}"
{{ addHTML_tdnb(procedure.date|date('d-M-Y')) }}
{% endif %}

{# *** HTML td 3: reason #}
{% if procedure.reason is empty %}
{{ addHTML_td("-") }}
{% else %}
* reasonCode.coding[0] = {{ procedure.reason.system }}#{{ procedure.reason.code }} "{{ procedure.reason.display }}"
{{ addHTML_td(procedure.reason.display) }}
{% endif %}

* subject = Reference(urn:uuid:{{ patient.instanceid }}) "{{ patient.name }}"

{{ addHTML_trend() -}}

{# populate .text #}
* text.status = #generated
* text.div = """
<div xmlns="http://www.w3.org/1999/xhtml">
<table class="hl7__ips">{{ emitHTML() | raw }}</table>
</div>
"""

%%HEAD%% {# tag required, content below maybe emtpy #}
{{ emitHEAD() | raw }}

%%HTML%% {# tag required, content below maybe emtpy #}
{{ emitHTML() | raw }}