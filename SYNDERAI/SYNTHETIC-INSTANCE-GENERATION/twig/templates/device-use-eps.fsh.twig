{#
  This is the TWIG file for the creation of an FSH instance including the HTML parts.
  see README.md

  KH since 2025-09-12
#}

%%FSH%% {# tag required #}

{# first emit the device #}
Instance: {{ setInstance("Instance-Device-" ~ deinstanceid) }}
InstanceOf: DeviceEuEps
Title: "Device"
Description: "Device"
Usage: #inline

* id = "{{ deinstanceid }}"

* status = #active {# always still active in our cases #}

* patient = Reference(urn:uuid:{{ patient.instanceid }}) "{{ patient.name }}"

* udiCarrier[0].id = "{{ device.uid }}"

{% if device.code is not empty %}
* type = {{ device.system }}#{{ device.code }} "{{ device.display }}"
{% endif %}

{# now the device use statement #}
Instance: {{ setInstance("Instance-DeviceUse-" ~ duinstanceid) }}
InstanceOf: DeviceUseStatementEuEps
Title: "Device Use"
Description: "Device Use"
Usage: #inline

* id = "{{ duinstanceid }}"

{# addign headers for HTML table #}
{{ addHEAD_tr() }}
{{ addHEAD_th("Device") }}
{{ addHEAD_th("Date (since)") }}
{{ addHEAD_trend() -}}

{{ addHTML_tr() }}

* status = #active {# always still active in our cases #}

{# *** HTML td 1: device #}
{{ addHTML_td(device.display) }}

{# *** HTML td 2: date since #}
{% if device.start is empty %}
* timing.extension.url = "http://hl7.org/fhir/StructureDefinition/data-absent-reason"
* timing.extension.valueCode = #unknown
{{ addHTML_td("?") }}
{% else %}
* timingPeriod.start = "{{ device.start }}"
{{ addHTML_tdnb(device.start|date('d-M-Y')) -}}
{% endif %}

* device = Reference(urn:uuid:{{ deinstanceid }}) "{{ device.display }}"

* subject = Reference(urn:uuid:{{ patient.instanceid }}) "{{ patient.name }}"

{{ addHTML_trend() -}}

{# populate .text #}
* text.status = #generated
* text.div = """
<div xmlns="http://www.w3.org/1999/xhtml">
<table class="hl7__ips">{{ emitHTML() | raw }}</table>
</div>
"""

%%HEAD%% {# tag required, content below maybe emtpy #}
{{ emitHEAD() | raw }}

%%HTML%% {# tag required, content below maybe emtpy #}
{{ emitHTML() | raw }}